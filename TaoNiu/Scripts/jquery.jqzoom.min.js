(function($){
	$.fn.jqueryzoom=function(){
		var src=$(".jqzoom img").attr("src");
		var str=src.split("/");
		var href=str[str.length-1];
		var reg=href.replace(/t/,"o");
		var len=str.length;
		var strN="";
		var n=0;
		var m=0;
		var settings={
				xzoom:400,
				yzoom:300,
				offset:10,
				position:"right",
				lens:1
			};
		var noalt='';
		for(var i=0; i<len-1; i++){
			strN +=str[i]+"/";
		}
		var altImg=function (){
			var sStr="<div id='div_opacity'></div><div id='altImg'><div class='imgDiv'><div class='btn_close shopProduct_close'></div><img  src='" + strN+reg + "' alt='' /></div></div>";
			$("body").append(sStr);
			// $("#altImg img").attr("src",strN+reg);
			var imgW=$("#altImg img").width();
			var imgH=$("#altImg img").height();
			if($("#altImg img").attr("src")==""){ 
				$("#div_opacity").remove();
				$("#altImg").remove();
			}
			if(imgW>=imgH){
				n = (imgW>1440)? 4.5:((imgW>1024)? 3:(imgW>900)? 2:0);
				imgW=imgW-(imgW/10)*n;
				$("#altImg img").width(imgW);
			}else{
				m = (imgH>1440)? 4.5:((imgH>1024)? 3:(imgH>900)? 2:0);
				imgH=imgH-(imgH/10)*m;
				$("#altImg img").height(imgH);
			}
			if(n==0){$(".imgDiv").css("marginTop","180px");}
			if($.browser.version=="6.0"){
				var mL=imgW;
			}else{
				var mL=(imgW+$(window).width())/2-18;			
			}
			$(".btn_close").css({"marginLeft":mL}).hover(function(){
				$(this).addClass("rotate");
			},function(){
				$(this).removeClass("rotate");
			});
			$("#div_opacity").css({"width":$(window).width(),"height":$("body").height()});
			$(".btn_close").bind("click",function(){
				$("#div_opacity").remove();
				$("#altImg").remove();
			});
			$("div.zoomdiv").remove();
			$(".jqZoomPup").remove();
		}
		$(".jqzoom img").attr("jqimg",strN+reg);
		$(".jqzoom img").bind("click",altImg);
		$(this).hover(function(){
			var imageLeft=$(this).offset().left;
			var imageTop=$(this).offset().top;
			var imageWidth=$(this).children('img').get(0).offsetWidth;
			var imageHeight=$(this).children('img').get(0).offsetHeight;
			noalt=$(this).children("img").attr("alt");
			var bigimage=$(this).children("img").attr("jqimg");
			$(this).children("img").attr("alt",'');
			if($("div.zoomdiv").get().length==0){
				$(this).after("<div class='zoomdiv'><img class='bigimg' src='"+bigimage+"'/></div>");
				$(this).append("<div class='jqZoomPup'>&nbsp;</div>");
			}
			if(settings.position=="right"){
				if(imageLeft+imageWidth+settings.offset+settings.xzoom>screen.width){
					leftpos=imageLeft-settings.offset-settings.xzoom;
				}else{
					leftpos=imageLeft+imageWidth+settings.offset;
				}
			}else{
				leftpos=imageLeft-settings.xzoom-settings.offset;
				if(leftpos<0){
					leftpos=imageLeft+imageWidth+settings.offset;
				}
			}
			$("div.zoomdiv").css({"top":imageTop,"left":leftpos});
			$("div.zoomdiv").width(settings.xzoom);
			$("div.zoomdiv").height(settings.yzoom);
			$("div.zoomdiv").show();
			
			$(".jqZoomPup").bind("click",altImg);
			$(document.body).mousemove(function(e){
				mouse=new MouseEvent(e);
				var bigwidth=$(".bigimg").get(0).offsetWidth;
				var bigheight=$(".bigimg").get(0).offsetHeight;
				var scaley='x';
				var scalex='y';
				if(isNaN(scalex)|isNaN(scaley)){
					var scalex=(bigwidth/imageWidth);
					var scaley=(bigheight/imageHeight);
					if(scalex<2){ 						
						$("div.zoomdiv").hide();
						return ;
					}
					if(scaley<2){ 						
						$("div.zoomdiv").hide();
						return ;
					}
					$("div.jqZoomPup").width((settings.xzoom)/scalex);
					$("div.jqZoomPup").height((settings.yzoom)/scaley);
					if(settings.lens){
						$("div.jqZoomPup").css('visibility','visible');
					}
				}
				xpos=mouse.x-$("div.jqZoomPup").width()/2-imageLeft;
				ypos=mouse.y-$("div.jqZoomPup").height()/2-imageTop;
				if(settings.lens){
					xpos=(mouse.x-$("div.jqZoomPup").width()/2<imageLeft)?0:((mouse.x+$("div.jqZoomPup").width()/2>imageWidth+imageLeft)?(imageWidth-$("div.jqZoomPup").width()):xpos);
					ypos=(mouse.y-$("div.jqZoomPup").height()/2<imageTop)?0:((mouse.y+$("div.jqZoomPup").height()/2>imageHeight+imageTop)?(imageHeight-$("div.jqZoomPup").height()):ypos);
				}
				if(settings.lens){
					$("div.jqZoomPup").css({"top":ypos,"left":xpos});
					scrolly=ypos;
					$("div.zoomdiv").get(0).scrollTop=scrolly*scaley;
					scrollx=xpos;
					$("div.zoomdiv").get(0).scrollLeft=(scrollx)*scalex;
				}
			}
		)},function(){
			$(this).children("img").attr("alt",noalt);
			$(document.body).unbind("mousemove");
			if(settings.lens){
				$("div.jqZoomPup").remove();
			}
			$("div.zoomdiv").remove();
		});
	}
})(jQuery);
	function MouseEvent(e){
		this.x=e.pageX;
		this.y=e.pageY;
	}